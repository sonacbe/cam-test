<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const debug = document.getElementById('debug');

async function init() {
    try {
        await tf.setBackend('webgl');
        await tf.ready();

        debug.innerText = "ì¹´ë©”ë¼ ì—°ê²° ì¤‘...";

        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "user", width: { ideal: 640 }, height: { ideal: 480 } },
            audio: false
        });

        video.srcObject = stream;

        // ğŸ¯ ë©”íƒ€ë°ì´í„° ë¡œë“œ ëŒ€ê¸°
        await new Promise(res => {
            video.onloadedmetadata = () => res();
        });

        video.play();

        // ğŸ¯ ìº”ë²„ìŠ¤ í•´ìƒë„ ë™ê¸°í™”
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        debug.innerText = "ëª¨ë¸ ë¡œë”© ì¤‘...";

        const detector = await faceDetection.createDetector(
            faceDetection.SupportedModels.MediaPipeFaceDetector,
            { runtime: 'tfjs', modelType: 'short' }
        );

        // ğŸ¯ ëª¨ë¸ ì›Œë°ì—… (zero box ë°©ì§€)
        await detector.estimateFaces(video);

        debug.innerText = "ì–¼êµ´ íƒì§€ ì‹œì‘";

        async function loop() {

            const faces = await detector.estimateFaces(video, { flipHorizontal: false });

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (faces && faces.length > 0) {
                const face = faces[0];

                // ğŸ¯ box í•„ë“œ ì•ˆì „ íŒŒì‹±
                const box = face.box || face.boundingBox;

                if (box) {
                    let x = box.xMin ?? box.x ?? 0;
                    let y = box.yMin ?? box.y ?? 0;
                    let w = box.width ?? (box.xMax - box.xMin);
                    let h = box.height ?? (box.yMax - box.yMin);

                    if (w > 0 && h > 0) {
                        debug.innerHTML = `ê°ì§€ë¨! X:${Math.round(x)} Y:${Math.round(y)}<br>W:${Math.round(w)} H:${Math.round(h)}`;

                        ctx.strokeStyle = "#00FF00";
                        ctx.lineWidth = 4;
                        ctx.strokeRect(x, y, w, h);
                    } else {
                        debug.innerText = "ë°•ìŠ¤ ê³„ì‚° ëŒ€ê¸° ì¤‘...";
                    }
                }
            } else {
                debug.innerText = `ì–¼êµ´ íƒìƒ‰ ì¤‘... (${video.videoWidth}x${video.videoHeight})`;
            }

            requestAnimationFrame(loop);
        }

        loop();

    } catch (err) {
        debug.innerText = "ì—ëŸ¬: " + err.message;
    }
}

init();
</script>
