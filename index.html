<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>얼굴 인식 v0.3</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core@4.10.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter@4.10.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@4.10.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-detection@1.0.2"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; position: fixed; width: 100%; height: 100%; }
        /* 비디오를 화면에 꽉 채우되 비율 유지 */
        video { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; object-fit: contain; z-index: 1; }
        /* 캔버스를 비디오와 완전히 동일한 위치/크기로 설정 */
        canvas { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; object-fit: contain; z-index: 2; pointer-events: none; }
        #status { position: fixed; top: 10px; left: 10px; color: #0f0; background: rgba(0,0,0,0.6); padding: 8px; z-index: 10; font-size: 14px; border-radius: 5px; }
    </style>
</head>
<body>
    <div id="status">상태: 준비 중...</div>
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusLabel = document.getElementById('status');

        async function setup() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "user" },
                    audio: false
                });
                video.srcObject = stream;
                
                statusLabel.innerText = "모델 로딩 중...";
                const model = faceDetection.SupportedModels.MediaPipeFaceDetector;
                const detector = await faceDetection.createDetector(model, { runtime: 'tfjs', modelType: 'short' });
                
                statusLabel.innerText = "인식 시작!";

                function render() {
                    if (video.readyState === 4) {
                        // 1. 캔버스 해상도를 비디오 원본 해상도와 일치시킴 (중요)
                        if (canvas.width !== video.videoWidth) {
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                        }

                        detector.estimateFaces(video).then(faces => {
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            
                            if (faces.length > 0) {
                                statusLabel.innerText = `${faces.length}명 감지됨`;
                                faces.forEach(face => {
                                    const { xMin, yMin, width, height } = face.box;
                                    
                                    // 박스 그리기
                                    ctx.strokeStyle = "#00FF00";
                                    ctx.lineWidth = Math.max(4, canvas.width / 100); // 해상도에 따른 선 굵기 조절
                                    ctx.strokeRect(xMin, yMin, width, height);
                                    
                                    // 텍스트 추가 (인식 확인용)
                                    ctx.fillStyle = "#00FF00";
                                    ctx.font = `${Math.max(16, canvas.width / 30)}px Arial`;
                                    ctx.fillText("Face", xMin, yMin > 20 ? yMin - 10 : 20);
                                });
                            }
                        });
                    }
                    requestAnimationFrame(render);
                }
                render();
            } catch (e) {
                statusLabel.innerText = "에러: " + e.message;
            }
        }
        setup();
    </script>
</body>
</html>
