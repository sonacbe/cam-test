<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>얼굴 인식 v0.4</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core@4.10.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter@4.10.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@4.10.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-detection@1.0.2"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; position: fixed; width: 100%; height: 100%; }
        /* 비디오와 캔버스를 화면 중앙에 배치 */
        video, canvas { 
            position: absolute; top: 0; left: 0; 
            width: 100vw; height: 100vh; 
            object-fit: contain; 
        }
        video { z-index: 1; }
        canvas { z-index: 2; pointer-events: none; } /* 캔버스가 위에 와야 함 */
        
        #status { 
            position: fixed; top: 10px; left: 10px; right: 10px;
            color: #fff; background: rgba(255, 0, 0, 0.7); 
            padding: 10px; z-index: 10; font-family: monospace; font-size: 12px;
            border-radius: 5px; line-height: 1.4;
        }
    </style>
</head>
<body>
    <div id="status">상태: 시스템 시작 중...</div>
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusLabel = document.getElementById('status');

        async function init() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "user" },
                    audio: false
                });
                video.srcObject = stream;
                
                statusLabel.innerText = "모델 로드 중...";
                const model = faceDetection.SupportedModels.MediaPipeFaceDetector;
                const detector = await faceDetection.createDetector(model, { runtime: 'tfjs', modelType: 'short' });
                
                statusLabel.innerText = "카메라 대기 중...";

                function detect() {
                    if (video.readyState === 4) {
                        // 해상도 동기화
                        if (canvas.width !== video.videoWidth) {
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                        }

                        detector.estimateFaces(video).then(faces => {
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            
                            if (faces.length > 0) {
                                const face = faces[0];
                                const { xMin, yMin, width, height } = face.box;

                                // 1. 상단에 좌표값 출력
                                statusLabel.innerHTML = `
                                    <b>[감지 성공]</b><br>
                                    좌표 - X: ${Math.round(xMin)}, Y: ${Math.round(yMin)}<br>
                                    크기 - W: ${Math.round(width)}, H: ${Math.round(height)}<br>
                                    캔버스 크기: ${canvas.width}x${canvas.height}
                                `;

                                // 2. 박스 그리기 (색상을 더 눈에 띄게 변경)
                                ctx.strokeStyle = "red"; 
                                ctx.lineWidth = 10; // 아주 굵게 설정
                                ctx.strokeRect(xMin, yMin, width, height);

                                // 3. 테스트용 점 (좌측 상단 인식 확인용)
                                ctx.fillStyle = "yellow";
                                ctx.fillRect(xMin, yMin, 20, 20);
                                
                            } else {
                                statusLabel.innerText = "얼굴을 찾는 중...";
                            }
                        });
                    }
                    requestAnimationFrame(detect);
                }
                detect();
            } catch (e) {
                statusLabel.innerText = "에러 발생: " + e.message;
            }
        }
        init();
    </script>
</body>
</html>
